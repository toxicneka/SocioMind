from aiogram import Router, F
from aiogram.types import Message
from aiogram.filters import Command
from aiogram.enums import ChatType
from services.gigachat import GigaChatService
from utils.helpers import get_user_type, get_all_users_with_types, get_chat_messages_last_7_days, get_chat_members, save_report, get_today_report
from datetime import datetime, timedelta
import asyncio

router = Router()
gigachat_service = GigaChatService()

@router.message(Command("report"), F.chat.type.in_({ChatType.GROUP, ChatType.SUPERGROUP}))
async def cmd_report(message: Message):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —É –±–æ—Ç–∞
    try:
        bot_member = await message.bot.get_chat_member(message.chat.id, message.bot.id)
        if bot_member.status not in ['administrator', 'creator']:
            await message.answer(
                "‚ùå <b>–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≥—Ä—É–ø–ø—ã –±–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!</b>\n\n"
                "–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –±–æ—Ç—É –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
                parse_mode="HTML"
            )
            return
    except Exception as e:
        await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –±–æ—Ç–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª—Å—è –ª–∏ –æ—Ç—á–µ—Ç —Å–µ–≥–æ–¥–Ω—è
    existing_report = await get_today_report(message.chat.id)
    if existing_report:
        await message.answer(
            "üìä <b>–û—Ç—á–µ—Ç —É–∂–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª—Å—è —Å–µ–≥–æ–¥–Ω—è!</b>\n\n"
            "–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /report –∑–∞–≤—Ç—Ä–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.",
            parse_mode="HTML"
        )
        return

    await message.answer("üîç –ù–∞—á–∏–Ω–∞—é –∞–Ω–∞–ª–∏–∑ –≥—Ä—É–ø–ø—ã...")

    try:
        # –ü–æ–ª—É—á–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞ –∏–∑ –Ω–∞—à–µ–π –±–∞–∑—ã
        chat_members = await get_chat_members(message.chat.id)
        
        if not chat_members:
            await message.answer(
                "‚ùå <b>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</b>\n\n"
                "–ë–æ—Ç –¥–æ–ª–∂–µ–Ω –Ω–∞–∫–æ–ø–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤. "
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ —á–∞—Ç–µ.",
                parse_mode="HTML"
            )
            return

        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ç–∏–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏–∑ –ë–î
        typed_users = await get_all_users_with_types()
        typed_user_ids = {user['user_id'] for user in typed_users}
        typed_users_dict = {user['user_id']: user for user in typed_users}

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        typed_members = []
        untyped_members = []
        
        for member in chat_members:
            user_id = member['user_id']
            username = member['username'] or member['first_name']
            
            if user_id in typed_user_ids:
                personality_type = typed_users_dict[user_id]['personality_type']
                typed_members.append({
                    'username': f"@{username}" if member['username'] else username,
                    'type': personality_type
                })
            else:
                untyped_members.append(username)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 70% –ø–æ—Ä–æ–≥–∞
        total_members = len(chat_members)
        typed_count = len(typed_members)
        
        if total_members == 0:
            await message.answer("‚ùå –í –≥—Ä—É–ø–ø–µ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.")
            return

        percentage = (typed_count / total_members) * 100
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        stats_message = (
            f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—Ä—É–ø–ø—ã \"{message.chat.title}\":</b>\n"
            f"–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {total_members}\n"
            f"–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ: {typed_count}\n"
            f"–ü—Ä–æ—Ü–µ–Ω—Ç: {percentage:.1f}%\n"
        )
        
        if typed_members:
            typed_list = "\n".join([f"‚Ä¢ {m['username']}: {m['type']}" for m in typed_members])
            stats_message += f"\n<b>–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏:</b>\n{typed_list}"
        
        if untyped_members and len(untyped_members) <= 10:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ–ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–µ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ
            untyped_list = ", ".join(untyped_members[:10])
            if len(untyped_members) > 10:
                untyped_list += f" –∏ –µ—â–µ {len(untyped_members) - 10}"
            stats_message += f"\n\n<b>–ù–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã:</b> {untyped_list}"

        await message.answer(stats_message, parse_mode="HTML")

        if percentage < 70:
            await message.answer(
                f"<b>üì¢ –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —á—Ç–æ–±—ã >70% —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–æ—à–ª–∏ —Ç–µ—Å—Ç</b>\n"
                f"<b>–ù–µ–ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏: {untyped_list}</b>\n"
                f"<b>–ü—Ä–æ–π–¥–∏—Ç–µ —Ç–µ—Å—Ç –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ —Å –±–æ—Ç–æ–º:\n</b>"
                f"1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ @SocioMind\n" 
                f"2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /test\n\n"
                f"<i>–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ —á–∞—Ç–µ –¥–ª—è –±—É–¥—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</i>",
                parse_mode="HTML"
            )
            return

        await message.answer("üîÆ <b>–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–∏–Ω–∞–º–∏–∫—É –≥—Ä—É–ø–ø—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ 7 –¥–Ω–µ–π...</b>", parse_mode="HTML")
        
        # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ 7 –¥–Ω–µ–π
        chat_history = await get_chat_messages_last_7_days(message.chat.id)
        
        # –ê–Ω–∞–ª–∏–∑ –≥—Ä—É–ø–ø—ã —Å —É—á–µ—Ç–æ–º –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        analysis = await analyze_group_with_history(
            message, 
            typed_members, 
            total_members, 
            typed_count, 
            chat_history
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç
        await save_report(message.chat.id, analysis)
        await message.answer(analysis, parse_mode="HTML")
        
    except Exception as e:
        await message.answer(
            f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –≥—Ä—É–ø–ø—ã: {str(e)}\n"
            f"–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ –≥—Ä—É–ø–ø–µ."
        )
        print(f"Error in group analysis: {e}")

async def analyze_group_with_history(message: Message, typed_members: list, total_members: int, typed_count: int, chat_history: list) -> str:
    """–ê–Ω–∞–ª–∏–∑ –≥—Ä—É–ø–ø—ã —Å –∏—Å—Ç–æ—Ä–∏–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π"""
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    history_text = ""
    if chat_history:
        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        user_messages = {}
        for msg in chat_history:
            user_id = msg['user_id']
            if user_id not in user_messages:
                user_messages[user_id] = []
            user_messages[user_id].append(msg['message_text'])
        
        # –°–æ–∑–¥–∞–µ–º —Å–≤–æ–¥–∫—É –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        history_text = "–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ 7 –¥–Ω–µ–π:\n"
        for user_id, messages in list(user_messages.items())[:10]:  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è
            user_info = next((m for m in typed_members if str(user_id) in m['username']), None)
            username = user_info['username'] if user_info else f"User_{user_id}"
            history_text += f"\n{username} ({len(messages)} —Å–æ–æ–±—â–µ–Ω–∏–π):\n"
            # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            for msg in messages[-3:]:
                history_text += f"- {msg[:100]}{'...' if len(msg) > 100 else ''}\n"

    members_info = [f"‚Ä¢ {m['username']}: {m['type']}" for m in typed_members]
    
    prompt = f"""
    –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∏–Ω–∞–º–∏–∫—É –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–æ–≤ –ª–∏—á–Ω–æ—Å—Ç–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π.
    –î–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.

    –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ì–†–£–ü–ü–ï:
    - –ù–∞–∑–≤–∞–Ω–∏–µ: "{message.chat.title}"
    - –í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {total_members}
    - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö: {typed_count}

    –¢–ò–ü–´ –õ–ò–ß–ù–û–°–¢–ò –£–ß–ê–°–¢–ù–ò–ö–û–í:
    {chr(10).join(members_info)}

    –ò–°–¢–û–†–ò–Ø –°–û–û–ë–©–ï–ù–ò–ô –ò–ó –ß–ê–¢–ê (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π):
    {history_text}

    –ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –∏ –¥–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ, –≤—ã–ø–æ–ª–Ω–∏–º—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
    –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –∫–æ–º–∞–Ω–¥—ã.

    –®–ê–ë–õ–û–ù –û–¢–í–ï–¢–ê (–∞–Ω–∞–ª–∏–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è parse_mode="HTML", –≤–º–µ—Å—Ç–æ –º–Ω–æ–≥–æ—Ç–æ—á–∏–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—Å—Ç–∞–≤–ª–µ–Ω –∞–Ω–∞–ª–∏–∑):
    <b>–£—á–∞—Å—Ç–Ω–∏–∫–∏: </b>
    {chr(10).join(members_info)}
    üîç <b>–ù–∞–±–ª—é–¥–µ–Ω–∏—è: </b>
    ‚Ä¢ ...
    ‚Ä¢ ...
    ‚Ä¢ ...
    ‚Ä¢ ...

    üí° <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: </b>
    ‚Ä¢ ...
    ‚Ä¢ ...
    ‚Ä¢ ...

    –ü–†–ò–ú–ï–† –û–¢–í–ï–¢–ê:
    <b>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</b>
    ‚Ä¢ @toxnela (ISFJ) - 45% —Å–æ–æ–±—â–µ–Ω–∏–π
    ‚Ä¢ @riama_01 (INFJ) - 30% —Å–æ–æ–±—â–µ–Ω–∏–π
    ‚Ä¢ @riama_01 (INTP) - 25% —Å–æ–æ–±—â–µ–Ω–∏–π

    üîç <b>–ù–∞–±–ª—é–¥–µ–Ω–∏—è: </b>
    ‚Ä¢ ISFJ: –°—Ç—Ä–µ–º–∏—Ç—Å—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –¥—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É, —á—É—Ç–∫–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º –æ–∫—Ä—É–∂–∞—é—â–∏—Ö.
    ‚Ä¢ INFJ: –ì–ª—É–±–æ–∫–æ –∑–∞–¥—É–º—á–∏–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ –≤—ã—è–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ–≥–æ —Å–º—ã—Å–ª–∞ –∏ –º–æ—Ç–∏–≤–∞—Ü–∏–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤.
    ‚Ä¢ INTP: –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç –ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∏ —Ç–µ–æ—Ä–µ—Ç–∏–∑–∞—Ü–∏—é, –º–µ–Ω—å—à–µ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–∞—Ö –±–µ—Å–µ–¥—ã.

    üí° <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: </b>
    ‚Ä¢ ISFJ: –í–∞–∂–Ω–æ –ø—Ä–æ—è–≤–ª—è—Ç—å —Ç–µ—Ä–ø–∏–º–æ—Å—Ç—å –∫ —Ä–∞–∑–ª–∏—á–Ω—ã–º —Å—Ç–∏–ª—è–º –æ–±—â–µ–Ω–∏—è –∏ –ø–æ–∑–≤–æ–ª—è—Ç—å –¥—Ä—É–≥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –≤—ã—Ä–∞–∂–∞—Ç—å —Å–µ–±—è —Å–≤–æ–±–æ–¥–Ω–æ, –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –ø—Ä–∏–≤—ã—á–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞.
    ‚Ä¢ INFJ: –°—Ç–∞—Ä–∞–π—Ç–µ—Å—å —É—Ä–∞–≤–Ω–æ–≤–µ—à–∏–≤–∞—Ç—å –≥–ª—É–±–∏–Ω—É –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è —Å —è—Å–Ω–æ—Å—Ç—å—é –∏–∑–ª–æ–∂–µ–Ω–∏—è —Ñ–∞–∫—Ç–æ–≤, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∫–æ–º—Ñ–æ—Ä—Ç–Ω—É—é —Å—Ä–µ–¥—É –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.
    ‚Ä¢ INTP: –ü—Ä–∏–∑–Ω–∞–≤–∞–π—Ç–µ –∑–Ω–∞—á–∏–º–æ—Å—Ç—å –ª–∏—á–Ω–æ–≥–æ –æ–ø—ã—Ç–∞ –∏ —á—É–≤—Å—Ç–≤ –¥—Ä—É–≥–∏—Ö —á–ª–µ–Ω–æ–≤ –∫–æ–º–∞–Ω–¥—ã, —É—á–∞—Å—Ç–≤—É–π—Ç–µ –≤ –¥–∏–∞–ª–æ–≥–∞—Ö –±–æ–ª–µ–µ –æ—Ç–∫—Ä—ã—Ç–æ, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—è —É–≤–∞–∂–µ–Ω–∏–µ –∫ —Ü–µ–Ω–Ω–æ—Å—Ç—è–º –∫–æ–ª–ª–µ–≥.
    """

    try:
        if gigachat_service.enabled:
            response = await gigachat_service.generate_group_analysis(prompt)
            return f"üìä <b>–û—Ç—á–µ—Ç –∞–Ω–∞–ª–∏–∑–∞ –≥—Ä—É–ø–ø—ã \"{message.chat.title}\"</b>\n\n{response}"
        else:
            # –ó–∞–≥–ª—É—à–∫–∞ –µ—Å–ª–∏ GigaChat –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω
            return f"""üìä <b>–û—Ç—á–µ—Ç –¥–ª—è –≥—Ä—É–ø–ø—ã "{message.chat.title}"</b>

üë• <b>–£—á–∞—Å—Ç–Ω–∏–∫–∏ ({typed_count}/{total_members} –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã):</b>
{chr(10).join(members_info)}

üìù <b>–ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ 7 –¥–Ω–µ–π:</b>
{history_text[:500]}...

üí° <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–æ–±—â–∏–µ):</b>
‚Ä¢ –°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—á–∏–µ –ø–∞—Ä—ã, —É—á–∏—Ç—ã–≤–∞—è —Ç–∏–ø—ã –ª–∏—á–Ω–æ—Å—Ç–∏
‚Ä¢ –û—Ä–≥–∞–Ω–∏–∑—É–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–µ—Ç—Ä–æ—Å–ø–µ–∫—Ç–∏–≤—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –ø—Ä–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á
‚Ä¢ –†–∞–∑—Ä–∞–±–æ—Ç–∞–π—Ç–µ —á–µ—Ç–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

üîÆ <b>–î–ª—è –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å AI:</b>
–ù–∞—Å—Ç—Ä–æ–π—Ç–µ API –∫–ª—é—á GigaChat –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞"""
            
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –≥—Ä—É–ø–ø—ã: {e}")
        return f"""üìä <b>–û—Ç—á–µ—Ç –¥–ª—è –≥—Ä—É–ø–ø—ã "{message.chat.title}"</b>

üë• <b>–°–æ—Å—Ç–∞–≤ –≥—Ä—É–ø–ø—ã:</b>
{chr(10).join(members_info)}

üí° <b>–û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>
‚Ä¢ –£—á–∏—Ç—ã–≤–∞–π—Ç–µ —Ä–∞–∑–ª–∏—á–∏—è –≤ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å—Ç–∏–ª—è—Ö
‚Ä¢ –°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ —Ä–∞–±–æ—á–∏–µ –≥—Ä—É–ø–ø—ã
‚Ä¢ –ü–æ–æ—â—Ä—è–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç–æ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –ª–∏—á–Ω–æ—Å—Ç–∏"""